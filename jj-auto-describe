#!/bin/bash

[ -n "$OPENCODE_MODEL" ] || OPENCODE_MODEL=deepseek/deepseek-chat

# Cache for the initial all() log to avoid repeated jj log calls
ALL_COMMITS_CACHE=""

# Helper function to get the ordinal position of a commit in the full all() log
get_commit_ordinal() {
    local commit_id="$1"
    # Get all commits and find the line number (ordinal) of the specific commit
    jj log --no-graph -T 'commit_id++"\n"' -r 'all()' | grep -n "^$commit_id$" | cut -d: -f1
}

# Helper function to get commit ID by ordinal position from the full all() log
get_commit_by_ordinal() {
    local ordinal="$1"
    jj log --no-graph -T 'commit_id++"\n"' -r 'all()' | sed -n "${ordinal}p"
}

# Helper function to get ordinal using cached results (for initial setup)
get_commit_ordinal_initial() {
    local commit_id="$1"
    if [ -z "$ALL_COMMITS_CACHE" ]; then
        # Cache the all() log on first call
        ALL_COMMITS_CACHE=$(jj log --no-graph -T 'commit_id++"\n"' -r 'all()')
    fi
    echo "$ALL_COMMITS_CACHE" | grep -n "^$commit_id$" | cut -d: -f1
}

# Check if a selector argument is provided
if [ $# -eq 0 ]; then
    echo "Usage: $0 <commit-selector>"
    echo "Example: $0 'main..@'"
    echo "Example: $0 'draft()'"
    echo "Example: $0 '@-10..@'"
    exit 1
fi

SELECTOR="$1"

# Get list of commit IDs from the selector and their ordinal positions
echo "Finding commits matching: $SELECTOR"
COMMIT_IDS=$(jj log --no-graph -T 'commit_id++"\n"' -r "$SELECTOR")

if [ -z "$COMMIT_IDS" ]; then
    echo "No commits found matching selector: $SELECTOR"
    exit 1
fi

# Store commit IDs and their ordinal positions in arrays
ORDINALS=()
COMMITS=()
for COMMIT_ID in $COMMIT_IDS; do
    ORDINAL=$(get_commit_ordinal_initial "$COMMIT_ID")
    if [ -n "$ORDINAL" ]; then
        ORDINALS+=("$ORDINAL")
        COMMITS+=("$COMMIT_ID")
    fi
done

# Count commits
COMMIT_COUNT=${#COMMITS[@]}
echo "Found $COMMIT_COUNT commits to process"

# Process each commit by ordinal position
for i in "${!ORDINALS[@]}"; do
    ORDINAL="${ORDINALS[$i]}"
    ORIGINAL_COMMIT="${COMMITS[$i]}"

    echo ""

    # Get the current commit ID at this ordinal (may have changed)
    CURRENT_COMMIT=$(get_commit_by_ordinal "$ORDINAL")

    if [ -z "$CURRENT_COMMIT" ]; then
        echo "Warning: Could not find commit at ordinal $ORDINAL - skipping"
        continue
    fi

    echo "Processing commit (original/new/ordinal): $ORIGINAL_COMMIT/$CURRENT_COMMIT/$ORDINAL"

    # Show current commit details
    #echo "Current commit details:"
    #jj show "$CURRENT_COMMIT"

    # Run opencode to generate new commit message
    opencode run -m "$OPENCODE_MODEL" "Please use 'jj show $CURRENT_COMMIT' to look at this commit and then use 'jj describe --ignore-immutable -m \"NEW COMMIT MESSAGE\"' to set a better commit message. Focus on making the commit message clear, concise, and descriptive of what the commit actually does."
done
