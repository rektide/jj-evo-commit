#!/bin/bash

# Check if a selector argument is provided
if [ $# -eq 0 ]; then
    echo "Usage: $0 <commit-selector>"
    echo "Example: $0 'main..@'"
    echo "Example: $0 'draft()'"
    echo "Example: $0 '@-10..@'"
    exit 1
fi

SELECTOR="$1"

# Get list of commit IDs from the selector
echo "Finding commits matching: $SELECTOR"
COMMIT_IDS=$(jj log --no-graph -T 'commit_id++"\n"' -r "$SELECTOR")

if [ -z "$COMMIT_IDS" ]; then
    echo "No commits found matching selector: $SELECTOR"
    exit 1
fi

# Count commits
COMMIT_COUNT=$(echo "$COMMIT_IDS" | wc -l)
echo "Found $COMMIT_COUNT commits to process"

# Process each commit
for COMMIT_ID in $COMMIT_IDS; do
    echo ""
    echo "Processing commit: $COMMIT_ID"
    
    # Show current commit details
    echo "Current commit details:"
    jj show "$COMMIT_ID"
    
    # Run opencode to generate new commit message
    echo ""
    echo "Running opencode to generate new commit message..."
    opencode run "Please use 'jj show $COMMIT_ID' to look at this commit and then use 'jj describe --ignore-immutable -m \"NEW COMMIT MESSAGE\"' to set a better commit message. Focus on making the commit message clear, concise, and descriptive of what the commit actually does."
    
    echo "---"
    echo "Commit $COMMIT_ID processed."
    echo ""
done

echo "All commits processed!"